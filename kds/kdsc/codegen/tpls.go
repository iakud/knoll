package codegen

// Protobuf
const TemplateProtobuf = `
{{- /* BEGIN DEFINE */ -}}
{{- /* ENUM */ -}}
{{- define "Enum"}}
enum {{.Name}} {
{{- range .EnumFields}}
	{{.Name}} = {{.Value}};
{{- end}}
}
{{- end}}
{{- /* MESSAGE */ -}}
{{- define "Message"}}
message {{.Name}} {
{{- range .Fields}}
{{- if .Repeated}}
	repeated {{protoType .Type}} {{.Name}} = {{.Number}};
{{- else if .Map}}
	map<{{protoType .KeyType}}, {{protoType .Type}}> {{.Name}} = {{.Number}};
{{- else}}
	{{protoType .Type}} {{.Name}} = {{.Number}};
{{- end}}
{{- end}}
}
{{- end}}
{{- /* ENTITY */ -}}
{{- define "Entity"}}
{{- template "Message" .}}
{{- end}}
{{- /* COMPONENT */ -}}
{{- define "Component"}}
{{- template "Message" .}}
{{- end}}
{{- /* END DEFINE */ -}}
{{- /* BEGIN PROTOBUF */ -}}
// Code generated by kds. DO NOT EDIT.
// source: {{.SourceFile}}

edition = "2023";

package {{.Package}};

{{- if len .Imports}}
{{/* EMPTY LINE */}}
{{- end}}
{{- range .Imports}}
import "{{.}}.proto";
{{- end}}

{{- if len .ProtoImports}}
{{/* EMPTY LINE */}}
{{- range .ProtoImports}}
import "{{.}}";
{{- end}}
{{- end}}

option go_package="{{.ProtoGoPackage}}";

{{- range .Defs}}
{{- if eq .Kind "enum"}}
{{/* EMPTY LINE */}}
{{- template "Enum" .}}
{{- else if eq .Kind "entity"}}
{{/* EMPTY LINE */}}
{{- template "Entity" .}}
{{- else if eq .Kind "component"}}
{{/* EMPTY LINE */}}
{{- template "Component" .}}
{{- end}}
{{- end}}
{{- /* END PROTOBUF */ -}}
`

// Kds Go File
const TemplateKdsGo = `
{{- /* BEGIN DEFINE */ -}}
{{- /* FIELD TYPE */ -}}
{{- define "FieldType"}}
{{- if eq .TypeKind "enum"}}{{.Type}}
{{- else if eq .TypeKind "component"}}*{{.Type}}
{{- else}}{{goType .Type}}
{{- end}}
{{- end}}
{{- /* LIST TYPE */ -}}
{{- define "ListValueType"}}
{{- if eq .TypeKind "enum"}}{{.Type}}
{{- else if eq .TypeKind "component"}}*{{.Type}}
{{- else}}{{goType .Type}}
{{- end}}
{{- end}}
{{- /* MAP TYPE */ -}}
{{- define "MapValueType"}}
{{- if eq .TypeKind "enum"}}{{.Type}}
{{- else if eq .TypeKind "component"}}*{{.Type}}
{{- else}}{{goType .Type}}
{{- end}}
{{- end}}
{{- /* LIST PROTO TYPE */ -}}
{{- define "ListValueProtoType"}}
{{- if eq .TypeKind "enum"}}{{goProtoPackage .Type}}.{{.Type}}
{{- else if eq .TypeKind "component"}}*{{goProtoPackage .Type}}.{{.Type}}
{{- else if eq .Type "timestamp"}}*{{goProtoType .Type}}
{{- else if eq .Type "duration"}}*{{goProtoType .Type}}
{{- else if eq .Type "empty"}}*{{goProtoType .Type}}
{{- else}}{{goProtoType .Type}}
{{- end}}
{{- end}}
{{- /* MAP PROTO TYPE */ -}}
{{- define "MapValueProtoType"}}
{{- if eq .TypeKind "enum"}}{{goProtoPackage .Type}}.{{.Type}}
{{- else if eq .TypeKind "component"}}*{{goProtoPackage .Type}}.{{.Type}}
{{- else if eq .Type "timestamp"}}*{{goProtoType .Type}}
{{- else if eq .Type "duration"}}*{{goProtoType .Type}}
{{- else if eq .Type "empty"}}*{{goProtoType .Type}}
{{- else}}{{goProtoType .Type}}
{{- end}}
{{- end}}

{{- /* LIST */ -}}
{{- define "List"}}
type dirtyParentFunc_{{.Name}} func()

func (f dirtyParentFunc_{{.Name}}) invoke() {
	if f == nil {
		return
	}
	f()
}

type {{.Name}} struct {
	data []{{template "ListValueType" .}}

	dirty       bool
	dirtyParent dirtyParentFunc_{{.Name}}
}

func (x *{{.Name}}) Len() int {
	return len(x.data)
}

func (x *{{.Name}}) Clear() {
	if len(x.data) == 0 {
		return
	}
{{- if eq .TypeKind "component"}}
	for _, v := range x.data {
		if v != nil {
			v.dirtyParent = nil
		}
	}
{{- end}}
	clear(x.data)
	x.data = x.data[:0]
	x.markDirty()
}

func (x *{{.Name}}) Get(i int) {{template "ListValueType" .}} {
	return x.data[i]
}

func (x *{{.Name}}) Set(i int, v {{template "ListValueType" .}}) {
{{- if eq .TypeKind "component"}}
	if v != nil && v.dirtyParent != nil {
		panic("the component should be removed from its original place first")
	}
{{- end}}
	if v == x.data[i] {
		return
	}
{{- if eq .TypeKind "component"}}
	if x.data[i] != nil {
		x.data[i].dirtyParent = nil
	}
{{- end}}
	x.data[i] = v
{{- if eq .TypeKind "component"}}
	if v != nil {
		v.dirtyParent = func() {
			x.markDirty()
		}
		v.dirty |= uint64(0x01)
	}
{{- end}}
	x.markDirty()
}

func (x *{{.Name}}) Append(v ...{{template "ListValueType" .}}) {
{{- if eq .TypeKind "component"}}
	for i := range v {
		if v[i] != nil && v[i].dirtyParent != nil {
			panic("the component should be removed from its original place first")
		}
	}
{{- end}}
	if len(v) == 0 {
		return
	}
	x.data = append(x.data, v...)
{{- if eq .TypeKind "component"}}
	for i := range v {
		if v[i] != nil {
			v[i].dirtyParent = func() {
				x.markDirty()
			}
			v[i].dirty |= uint64(0x01)
		}
	}
{{- end}}
	x.markDirty()
}

func (x *{{.Name}}) Index(v {{template "ListValueType" .}}) int {
	for i := range x.data {
		if v == x.data[i] {
			return i
		}
	}
	return -1
}

func (x *{{.Name}}) IndexFunc(f func({{template "ListValueType" .}}) bool) int {
	for i := range x.data {
		if f(x.data[i]) {
			return i
		}
	}
	return -1
}

func (x *{{.Name}}) Contains(v {{template "ListValueType" .}}) bool {
	return x.Index(v) >= 0
}

func (x *{{.Name}}) ContainsFunc(f func({{template "ListValueType" .}}) bool) bool {
	return x.IndexFunc(f) >= 0
}

func (x *{{.Name}}) Insert(i int, v ...{{template "ListValueType" .}}) {
{{- if eq .TypeKind "component"}}
	for j := range v {
		if v[j] != nil && v[j].dirtyParent != nil {
			panic("the component should be removed from its original place first")
		}
	}
{{- end}}
	if len(v) == 0 {
		return
	}
	x.data = slices.Insert(x.data, i, v...)
{{- if eq .TypeKind "component"}}
	for j := range v {
		if v[j] != nil {
			v[j].dirtyParent = func() {
				x.markDirty()
			}
			v[j].dirty |= uint64(0x01)
		}
	}
{{- end}}
	x.markDirty()
}

func (x *{{.Name}}) Delete(i, j int) {
{{- if eq .TypeKind "component"}}
	r := x.data[i:j:len(x.data)]
	for k := range r {
		if r[k] != nil {
			r[k].dirtyParent = nil
		}
	}
{{- end}}
	if i == j {
		return
	}
	x.data = slices.Delete(x.data, i, j)
	x.markDirty()
}

func (x *{{.Name}}) DeleteFunc(del func({{template "ListValueType" .}}) bool) {
	i := x.IndexFunc(del)
	if i == -1 {
		return
	}
{{- if eq .TypeKind "component"}}
	x.data[i].dirtyParent = nil
{{- end}}
	for j := i + 1; j < len(x.data); j++ {
		v := x.data[j]
		if del(v) {
{{- if eq .TypeKind "component"}}
			v.dirtyParent = nil
{{- end}}
			continue
		}
		x.data[i] = v
		i++
	}
	clear(x.data[i:])
	x.data = x.data[:i]
	x.markDirty()
}

func (x *{{.Name}}) Replace(i, j int, v ...{{template "ListValueType" .}}) {
{{- if eq .TypeKind "component"}}
	for k := range v {
		if v[k] != nil && v[k].dirtyParent != nil {
			panic("the component should be removed from its original place first")
		}
	}
	r := x.data[i:j:len(x.data)]
	for k := range r {
		if r[k] != nil {
			r[k].dirtyParent = nil
		}
	}
{{- end}}
	if i == j && len(v) == 0 {
		return
	}
	x.data = slices.Replace(x.data, i, j, v...)
{{- if eq .TypeKind "component"}}
	for k := range v {
		if v[k] != nil {
			v[k].dirtyParent = func() {
				x.markDirty()
			}
			v[k].dirty |= uint64(0x01)
		}
	}
{{- end}}
	x.markDirty()
}

func (x *{{.Name}}) Reverse() {
	if len(x.data) < 2 {
		return
	}
	slices.Reverse(x.data)
	x.markDirty()
}

func (x *{{.Name}}) All() iter.Seq2[int, {{template "ListValueType" .}}] {
	return slices.All(x.data)
}

func (x *{{.Name}}) Backward() iter.Seq2[int, {{template "ListValueType" .}}] {
	return slices.Backward(x.data)
}

func (x *{{.Name}}) Values() iter.Seq[{{template "ListValueType" .}}] {
	return slices.Values(x.data)
}

func (x *{{.Name}}) DumpChange() []{{template "ListValueProtoType" .}} {
	return x.DumpFull()
}

func (x *{{.Name}}) DumpFull() []{{template "ListValueProtoType" .}} {
	var m []{{template "ListValueProtoType" .}}
{{- if eq .TypeKind "component"}}
	for _, v := range x.data {
		m = append(m, v.DumpChange())
	}
{{- else if eq .TypeKind "enum"}}
	for _, v := range x.data {
		m = append(m, v)
	}
{{- else if eq .Type "timestamp"}}
	for _, v := range x.data {
		m = append(m, timestamppb.New(v))
	}
{{- else if eq .Type "duration"}}
	for _, v := range x.data {
		m = append(m, durationpb.New(v))
	}
{{- else if eq .Type "empty"}}
	for range x.data {
		m = append(m, new(emptypb.Empty))
	}
{{- else}}
	for _, v := range x.data {
		m = append(m, v)
	}
{{- end}}
	return m
}

func (x *{{.Name}}) Load(m []{{template "ListValueProtoType" .}}) {
{{- if eq .TypeKind "component"}}
	for _, v := range m {
		c := New{{.Type}}()
		c.Load(v)
		x.data = append(x.data, c)
	}
{{- else if eq .TypeKind "enum"}}
	for _, v := range m {
		x.data = append(x.data, v)
	}
{{- else if eq .Type "timestamp"}}
	for _, v := range m {
		x.data = append(x.data, v.AsTime())
	}
{{- else if eq .Type "duration"}}
	for _, v := range m {
		x.data = append(x.data, v.AsDuration())
	}
{{- else if eq .Type "empty"}}
	for range m {
		x.data = append(x.data, struct{}{})
	}
{{- else}}
	for _, v := range m {
		x.data = append(x.data, v)
	}
{{- end}}
}

func (x *{{.Name}}) markDirty() {
	if x.dirty {
		return
	}
	x.dirty = true
	x.dirtyParent.invoke()
}

func (x *{{.Name}}) clearDirty() {
{{- if eq .TypeKind "component"}}
	for k := range x.data {
		if x.data[k] != nil {
			x.data[k].clearDirty()
		}
	}
{{- end}}
	x.dirty = false
}

func (x *{{.Name}}) Marshal(b []byte) ([]byte, error) {
	if len(x.data) == 0 {
		return b, nil
	}
	for _, v := range x.data {
{{- if eq .TypeKind "component"}}
		var err error
		if b, err = wire.AppendMessage(b, v); err != nil {
			return b, err
		}
{{- else if eq .TypeKind "enum"}}
		b = wire.AppendInt32(b, int32(v))
{{- else}}
		b = wire.Append{{ucFirst .Type}}(b, v)
{{- end}}
	}
	return b, nil
}

func (x *{{.Name}}) MarshalDirty(b []byte) ([]byte, error) {
	return x.Marshal(b)
}

func (x *{{.Name}}) Unmarshal(b []byte) error {
	x.Clear()
	for len(b) > 0 {
{{- if eq .TypeKind "component"}}
		v := New{{.Type}}()
		n, err := wire.ConsumeMessage(b, v)
		if err != nil {
			return err
		}
		b = b[n:]
		x.Append(v)
{{- else if eq .TypeKind "enum"}}
		v, n, err := wire.ConsumeInt32(b)
		if err != nil {
			return err
		}
		b = b[n:]
		x.Append({{.Type}}(v))
{{- else}}
		v, n, err := wire.Consume{{ucFirst .Type}}(b)
		if err != nil {
			return err
		}
		b = b[n:]
		x.Append(v)
{{- end}}
	}
	return nil
}
{{- end}}

{{- /* MAP */ -}}
{{- define "Map"}}
type dirtyParentFunc_{{.Name}} func()

func (f dirtyParentFunc_{{.Name}}) invoke() {
	if f == nil {
		return
	}
	f()
}

type {{.Name}} struct {
	data map[{{goType .KeyType}}]{{template "MapValueType" .}}

	clear       bool
	updates     map[{{goType .KeyType}}]{{template "MapValueType" .}}
	deletes     map[{{goType .KeyType}}]struct{}
	dirty       bool
	dirtyParent dirtyParentFunc_{{.Name}}
}

func (x *{{.Name}}) Len() int {
	return len(x.data)
}

func (x *{{.Name}}) Clear() {
	if len(x.data) == 0 && len(x.deletes) == 0 {
		return
	}
{{- if eq .TypeKind "component"}}
	for _, v := range x.data {
		if v != nil {
			v.dirtyParent = nil
		}
	}
{{- end}}
	clear(x.data)
	x.clear = true
	clear(x.updates)
	clear(x.deletes)
	x.markDirty()
}

func (x *{{.Name}}) Get(k {{goType .KeyType}}) ({{template "MapValueType" .}}, bool) {
	v, ok := x.data[k]
	return v, ok
}

func (x *{{.Name}}) Set(k {{goType .KeyType}}, v {{template "MapValueType" .}}) {
{{- if eq .TypeKind "component"}}
	if v != nil && v.dirtyParent != nil {
		panic("the component should be removed from its original place first")
	}
{{- end}}
	if e, ok := x.data[k]; ok {
		if e == v {
			return
		}
{{- if eq .TypeKind "component"}}
		if e != nil {
			e.dirtyParent = nil
		}
{{- end}}
	}
{{- if eq .TypeKind "component"}}
	if v != nil {
		v.dirtyParent = func() {
			if _, ok := x.updates[k]; ok {
				return
			}
			x.updates[k] = v
			x.markDirty()
		}
		v.dirty |= uint64(0x01)
	}
{{- end}}
	x.data[k] = v
	x.updates[k] = v
	delete(x.deletes, k)
	x.markDirty()
}

func (x *{{.Name}}) Delete(k {{goType .KeyType}}) {
{{- if eq .TypeKind "component"}}
	if v, ok := x.data[k]; !ok {
		return
	} else if v != nil {
		v.dirtyParent = nil
	}
{{- else}}
	if _, ok := x.data[k]; !ok {
		return
	}
{{- end}}
	delete(x.data, k)
	delete(x.updates, k)
	x.deletes[k] = struct{}{}
	x.markDirty()
}

func (x *{{.Name}}) All() iter.Seq2[{{goType .KeyType}}, {{template "MapValueType" .}}] {
	return maps.All(x.data)
}

func (x *{{.Name}}) Keys() iter.Seq[{{goType .KeyType}}] {
	return maps.Keys(x.data)
}

func (x *{{.Name}}) Values() iter.Seq[{{template "MapValueType" .}}] {
	return maps.Values(x.data)
}

func (x *{{.Name}}) DumpChange() map[{{goType .KeyType}}]{{template "MapValueProtoType" .}} {
	if x.clear {
		return x.DumpFull()
	}
	m := make(map[{{goType .KeyType}}]{{template "MapValueProtoType" .}})
{{- if eq .TypeKind "component"}}
	for k, v := range x.updates {
		m[k] = v.DumpFull()
	}
{{- else if eq .TypeKind "enum"}}
	for k, v := range x.updates {
		m[k] = v
	}
{{- else if eq .Type "timestamp"}}
	for k, v := range x.updates {
		m[k] = timestamppb.New(v)
	}
{{- else if eq .Type "duration"}}
	for k, v := range x.updates {
		m[k] = durationpb.New(v)
	}
{{- else if eq .Type "empty"}}
	for k := range x.updates {
		m[k] = new(emptypb.Empty)
	}
{{- else}}
	for k, v := range x.updates {
		m[k] = v
	}
{{- end}}
	for k, _ := range x.deletes {
		_ = k // deleteKeys
	}
	return m
}

func (x *{{.Name}}) DumpFull() map[{{goType .KeyType}}]{{template "MapValueProtoType" .}} {
	m := make(map[{{goType .KeyType}}]{{template "MapValueProtoType" .}})
{{- if eq .TypeKind "component"}}
	for k, v := range x.data {
		m[k] = v.DumpFull()
	}
{{- else if eq .TypeKind "enum"}}
	for k, v := range x.data {
		m[k] = v
	}
{{- else if eq .Type "timestamp"}}
	for k, v := range x.data {
		m[k] = timestamppb.New(v)
	}
{{- else if eq .Type "duration"}}
	for k, v := range x.data {
		m[k] = durationpb.New(v)
	}
{{- else if eq .Type "empty"}}
	for k := range x.data {
		m[k] = new(emptypb.Empty)
	}
{{- else}}
	for k, v := range x.data {
		m[k] = v
	}
{{- end}}
	return m
}

func (x *{{.Name}}) Load(m map[{{goType .KeyType}}]{{template "MapValueProtoType" .}}) {
{{- if eq .TypeKind "component"}}
	for k, v := range m {
		c := New{{.Type}}()
		c.Load(v)
		x.data[k] = c
	}
{{- else if eq .TypeKind "enum"}}
	for k, v := range m {
		x.data[k] = v
	}
{{- else if eq .Type "timestamp"}}
	for k, v := range m {
		x.data[k] = v.AsTime()
	}
{{- else if eq .Type "duration"}}
	for k, v := range m {
		x.data[k] = v.AsDuration()
	}
{{- else if eq .Type "empty"}}
	for k := range m {
		x.data[k] = struct{}{}
	}
{{- else}}
	for k, v := range m {
		x.data[k] = v
	}
{{- end}}
}

func (x *{{.Name}}) markDirty() {
	if x.dirty {
		return
	}
	x.dirty = true
	x.dirtyParent.invoke()
}

func (x *{{.Name}}) clearDirty() {
	if !x.dirty {
		return
	}
{{- if eq .TypeKind "component"}}
	for _, v := range x.updates {
		if v != nil {
			v.clearDirty()
		}
	}
{{- end}}
	x.clear = false
	clear(x.updates)
	clear(x.deletes)
	x.dirty = false
}

func (x *{{.Name}}) Marshal(b []byte) ([]byte, error) {
	var pos int
	var err error
	if b, err = wire.MarshalBool(b, wire.MapClearFieldNumber, true); err != nil {
		return b, err
	}
	for k, v := range x.data {
		b = wire.AppendTag(b, wire.MapEntryFieldNumber, wire.BytesType)
		b, pos = wire.AppendSpeculativeLength(b)
		if b, err = wire.Marshal{{ucFirst .KeyType}}(b, wire.MapEntryKeyFieldNumber, k); err != nil {
			return b, err
		}
{{- if eq .TypeKind "component"}}
		if b, err = wire.MarshalMessage(b, wire.MapEntryValueFieldNumber, v); err != nil {
			return b, err
		}
{{- else if eq .TypeKind "enum"}}
		if b, err = wire.MarshalInt32(b, wire.MapEntryValueFieldNumber, int32(v)); err != nil {
			return b, err
		}
{{- else}}
		if b, err = wire.Marshal{{ucFirst .Type}}(b, wire.MapEntryValueFieldNumber, v); err != nil {
			return b, err
		}
{{- end}}
		b = wire.FinishSpeculativeLength(b, pos)
	}
	return b, err
}

func (x *{{.Name}}) MarshalDirty(b []byte) ([]byte, error) {
	var pos int
	var err error
	if x.clear {
		if b, err = wire.MarshalBool(b, wire.MapClearFieldNumber, true); err != nil {
			return b, err
		}
	}
	if len(x.deletes) > 0 {
		b = wire.AppendTag(b, wire.MapDeleteFieldNumber, wire.BytesType)
		b, pos = wire.AppendSpeculativeLength(b)
		for k, _ := range x.deletes {
			b = wire.Append{{ucFirst .KeyType}}(b, k)
		}
		b = wire.FinishSpeculativeLength(b, pos)
	}
	for k, v := range x.updates {
		b = wire.AppendTag(b, wire.MapEntryFieldNumber, wire.BytesType)
		b, pos = wire.AppendSpeculativeLength(b)
		if b, err = wire.Marshal{{ucFirst .KeyType}}(b, wire.MapEntryKeyFieldNumber, k); err != nil {
			return b, err
		}
{{- if eq .TypeKind "component"}}
		if b, err = wire.MarshalMessage(b, wire.MapEntryValueFieldNumber, v); err != nil {
			return b, err
		}
{{- else if eq .TypeKind "enum"}}
		if b, err = wire.MarshalInt32(b, wire.MapEntryValueFieldNumber, int32(v)); err != nil {
			return b, err
		}
{{- else}}
		if b, err = wire.Marshal{{ucFirst .Type}}(b, wire.MapEntryValueFieldNumber, v); err != nil {
			return b, err
		}
{{- end}}
		b = wire.FinishSpeculativeLength(b, pos)
	}
	return b, err
}

func (x *{{.Name}}) Unmarshal(b []byte) error {
	var clear bool
	var deletes []byte
	var entries [][]byte
	for len(b) > 0 {
		num, wtyp, tagLen, err := wire.ConsumeTag(b)
		if err != nil {
			return err
		}
		var valLen int
		err = wire.ErrUnknown
		switch num {
		case wire.MapClearFieldNumber:
			clear, valLen, err = wire.UnmarshalBool(b[tagLen:], wtyp)
		case wire.MapDeleteFieldNumber:
			deletes, valLen, err = wire.UnmarshalBytes(b[tagLen:], wtyp)
		case wire.MapEntryFieldNumber:
			var entry []byte
			if entry, valLen, err = wire.UnmarshalBytes(b[tagLen:], wtyp); err != nil {
				break
			}
			entries = append(entries, entry)
		}
		if err == wire.ErrUnknown {
			if valLen, err = wire.ConsumeFieldValue(num, wtyp, b[tagLen:]); err != nil {
				return err
			}
		} else if err != nil {
			return err
		}
		b = b[tagLen+valLen:]
	}
	if clear {
		x.Clear()
	}
	for b := deletes; len(b) > 0; {
		k, n, err := wire.Consume{{ucFirst .KeyType}}(b)
		if err != nil {
			return err
		}
		b = b[n:]
		x.Delete(k)
	}
	for _, b := range entries {
		var k {{goType .KeyType}}
{{- if eq .TypeKind "component"}}
		var v []byte
{{- else}}
		var v {{template "MapValueType" .}}
{{- end}}
		for len(b) > 0 {
			num, wtyp, tagLen, err := wire.ConsumeTag(b)
			if err != nil {
				return err
			}
			var valLen int
			err = wire.ErrUnknown
			switch num {
			case wire.MapEntryKeyFieldNumber:
				k, valLen, err = wire.Unmarshal{{ucFirst .KeyType}}(b[tagLen:], wtyp)
			case wire.MapEntryValueFieldNumber:
{{- if eq .TypeKind "component"}}
				v, valLen, err = wire.UnmarshalBytes(b[tagLen:], wtyp)
{{- else if eq .TypeKind "enum"}}
				*(*int32)(&v), valLen, err = wire.UnmarshalInt32(b[tagLen:], wtyp)
{{- else}}
				v, valLen, err = wire.Unmarshal{{ucFirst .Type}}(b[tagLen:], wtyp)
{{- end}}
			}
			if err == wire.ErrUnknown {
				if valLen, err = wire.ConsumeFieldValue(num, wtyp, b[tagLen:]); err != nil {
					return err
				}
			} else if err != nil {
				return err
			}
			b = b[tagLen+valLen:]
		}
{{- if eq .TypeKind "component"}}
		if c, ok := x.data[k]; !ok {
			c = New{{.Type}}()
			if err := c.Unmarshal(v); err != nil {
				return err
			}
			x.Set(k, c)
		} else if err := c.Unmarshal(v); err != nil {
			return err
		}
{{- else if eq .TypeKind "enum"}}
		x.Set(k, v)
{{- else}}
		x.Set(k, v)
{{- end}}
	}
	return nil
}
{{- end}}

{{- /* ENUM */ -}}
{{- define "Enum"}}
{{- $EnumType := .Name}}
type {{.Name}} = {{.GoProtoPackage}}.{{.Name}}

const (
{{- range .EnumFields}}
	{{$EnumType}}_{{.Name}} {{$EnumType}} = {{.Value}}
{{- end}}
)
{{- end}}

{{- /* MESSAGE */ -}}
{{- define "Message"}}
{{- $MessageName := .Name}}

{{- range .Fields}}
{{/* EMPTY LINE */}}
{{- if .Repeated}}
func (x *{{$MessageName}}) Get{{.Name}}() *{{.ListType}} {
	return &x.xxx_hidden_{{.Name}}
}

func (x *{{$MessageName}}) init{{.Name}}() {
	x.xxx_hidden_{{.Name}}.dirtyParent = func() {
		x.markDirty(uint64(0x01) << {{.Number}})
	}
}
{{- else if .Map}}
func (x *{{$MessageName}}) Get{{.Name}}() *{{.MapType}} {
	return &x.xxx_hidden_{{.Name}}
}

func (x *{{$MessageName}}) init{{.Name}}() {
	x.xxx_hidden_{{.Name}}.data = make(map[{{goType .KeyType}}]{{template "FieldType" .}})
	x.xxx_hidden_{{.Name}}.updates = make(map[{{goType .KeyType}}]{{template "FieldType" .}})
	x.xxx_hidden_{{.Name}}.deletes = make(map[{{goType .KeyType}}]struct{})
	x.xxx_hidden_{{.Name}}.dirtyParent = func() {
		x.markDirty(uint64(0x01) << {{.Number}})
	}
}
{{- else if eq .TypeKind "component"}}
func (x *{{$MessageName}}) Get{{.Name}}() {{template "FieldType" .}} {
	return x.xxx_hidden_{{.Name}}
}

func (x *{{$MessageName}}) set{{.Name}}(v *{{.Type}}) {
	if v != nil && v.dirtyParent != nil {
		panic("the component should be removed from its original place first")
	}
	if v == x.xxx_hidden_{{.Name}} {
		return
	}
	if x.xxx_hidden_{{.Name}} != nil {
		x.xxx_hidden_{{.Name}}.dirtyParent = nil
	}
	x.xxx_hidden_{{.Name}} = v
	if v != nil {
		v.dirtyParent = func() {
			x.markDirty(uint64(0x01) << {{.Number}})
		}
		v.dirty |= uint64(0x01)
	}
	x.markDirty(uint64(0x01) << {{.Number}})
}
{{- else}}
func (x *{{$MessageName}}) Get{{.Name}}() {{template "FieldType" .}} {
	return x.xxx_hidden_{{.Name}}
}

func (x *{{$MessageName}}) Set{{.Name}}(v {{template "FieldType" .}}) {
{{- if eq .Type "bytes"}}
	if v == nil && x.xxx_hidden_{{.Name}} == nil {
		return
	}
{{- else if eq .Type "timestamp"}}
	if v.Equal(x.xxx_hidden_{{.Name}}) {
		return
	}
{{- else}}
	if v == x.xxx_hidden_{{.Name}} {
		return
	}
{{- end}}
	x.xxx_hidden_{{.Name}} = v
	x.markDirty(uint64(0x01) << {{.Number}})
}
{{- end}}
{{- end}}

func (x *{{$MessageName}}) DumpChange() *{{.GoProtoPackage}}.{{.Name}} {
	if x.dirty&uint64(0x01) != 0 {
		return x.DumpFull()
	}
	m := new({{.GoProtoPackage}}.{{.Name}})
{{- range .Fields}}
	if x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
{{- if .Repeated}}
		m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpChange())
{{- else if .Map}}
		m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpChange())
{{- else if eq .TypeKind "component"}}
		m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpChange())
{{- else if eq .Type "timestamp"}}
		m.Set{{.Name}}(timestamppb.New(x.xxx_hidden_{{.Name}}))
{{- else if eq .Type "duration"}}
		m.Set{{.Name}}(durationpb.New(x.xxx_hidden_{{.Name}}))
{{- else if eq .Type "empty"}}
		m.Set{{.Name}}(new(emptypb.Empty))
{{- else}}
		m.Set{{.Name}}(x.xxx_hidden_{{.Name}})
{{- end}}
	}
{{- end}}
	return m
}

func (x *{{$MessageName}}) DumpFull() *{{.GoProtoPackage}}.{{.Name}} {
	m := new({{.GoProtoPackage}}.{{.Name}})
{{- range .Fields}}
{{- if .Repeated}}
	m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpFull())
{{- else if .Map}}
	m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpFull())
{{- else if eq .TypeKind "component"}}
	m.Set{{.Name}}(x.xxx_hidden_{{.Name}}.DumpFull())
{{- else if eq .Type "timestamp"}}
	m.Set{{.Name}}(timestamppb.New(x.xxx_hidden_{{.Name}}))
{{- else if eq .Type "duration"}}
	m.Set{{.Name}}(durationpb.New(x.xxx_hidden_{{.Name}}))
{{- else if eq .Type "empty"}}
	m.Set{{.Name}}(new(emptypb.Empty))
{{- else}}
	m.Set{{.Name}}(x.xxx_hidden_{{.Name}})
{{- end}}
{{- end}}
	return m
}

func (x *{{$MessageName}}) Load(m *{{.GoProtoPackage}}.{{.Name}}) {
{{- range .Fields}}
{{- if .Repeated}}
	x.xxx_hidden_{{.Name}}.Load(m.Get{{.Name}}())
{{- else if .Map}}
	x.xxx_hidden_{{.Name}}.Load(m.Get{{.Name}}())
{{- else if eq .TypeKind "component"}}
	x.xxx_hidden_{{.Name}}.Load(m.Get{{.Name}}())
{{- else if eq .Type "timestamp"}}
	x.xxx_hidden_{{.Name}} = m.Get{{.Name}}().AsTime()
{{- else if eq .Type "duration"}}
	x.xxx_hidden_{{.Name}} = m.Get{{.Name}}().AsDuration()
{{- else if eq .Type "empty"}}
	x.xxx_hidden_{{.Name}} = struct{}{}
{{- else}}
	x.xxx_hidden_{{.Name}} = m.Get{{.Name}}()
{{- end}}
{{- end}}
}

func (x *{{$MessageName}}) Marshal(b []byte) ([]byte, error) {
	var err error
{{- range .Fields}}
{{- if .Repeated}}
	if b, err = wire.MarshalMessage(b, {{.Number}}, &x.xxx_hidden_{{.Name}}); err != nil {
		return b, err
	}
{{- else if .Map}}
	if b, err = wire.MarshalMessage(b, {{.Number}}, &x.xxx_hidden_{{.Name}}); err != nil {
		return b, err
	}
{{- else if eq .TypeKind "component"}}
	if b, err = wire.MarshalMessage(b, {{.Number}}, x.xxx_hidden_{{.Name}}); err != nil {
		return b, err
	}
{{- else if eq .TypeKind "enum"}}
	// FIXME: enum value
	if b, err = wire.MarshalInt32(b, {{.Number}}, int32(x.xxx_hidden_{{.Name}})); err != nil {
		return b, err
	}
{{- else}}
	if b, err = wire.Marshal{{ucFirst .Type}}(b, {{.Number}}, x.xxx_hidden_{{.Name}}); err != nil {
		return b, err
	}
{{- end}}
{{- end}}
	return b, err
}

func (x *{{$MessageName}}) MarshalDirty(b []byte) ([]byte, error) {
	if x.dirty&uint64(0x01) != 0 {
		return x.Marshal(b)
	}
	var err error
{{- range .Fields}}
	if x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
{{- if .Repeated}}
		if b, err = wire.MarshalMessageDirty(b, {{.Number}}, &x.xxx_hidden_{{.Name}}); err != nil {
			return b, err
		}
{{- else if .Map}}
		if b, err = wire.MarshalMessageDirty(b, {{.Number}}, &x.xxx_hidden_{{.Name}}); err != nil {
			return b, err
		}
{{- else if eq .TypeKind "component"}}
		if b, err = wire.MarshalMessageDirty(b, {{.Number}}, x.xxx_hidden_{{.Name}}); err != nil {
			return b, err
		}
{{- else if eq .TypeKind "enum"}}
		// FIXME: enum value
		if b, err = wire.MarshalInt32(b, {{.Number}}, int32(x.xxx_hidden_{{.Name}})); err != nil {
			return b, err
		}
{{- else}}
		if b, err = wire.Marshal{{ucFirst .Type}}(b, {{.Number}}, x.xxx_hidden_{{.Name}}); err != nil {
			return b, err
		}
{{- end}}
	}
{{- end}}
	return b, err
}

func (x *{{$MessageName}}) Unmarshal(b []byte) error {
	for len(b) > 0 {
		num, wtyp, tagLen, err := wire.ConsumeTag(b)
		if err != nil {
			return err
		}
		var valLen int
		err = wire.ErrUnknown
		switch num {
{{- range .Fields}}
		case {{.Number}}:
{{- if .Repeated}}
			valLen, err = wire.UnmarshalMessage(b[tagLen:], wtyp, &x.xxx_hidden_{{.Name}})
{{- else if .Map}}
			valLen, err = wire.UnmarshalMessage(b[tagLen:], wtyp, &x.xxx_hidden_{{.Name}})
{{- else if eq .TypeKind "component"}}
			valLen, err = wire.UnmarshalMessage(b[tagLen:], wtyp, x.xxx_hidden_{{.Name}})
{{- else if eq .TypeKind "enum"}}
			// FIXME: enum value
			*(*int32)(&x.xxx_hidden_{{.Name}}), valLen, err = wire.UnmarshalInt32(b[tagLen:], wtyp)
{{- else}}
			x.xxx_hidden_{{.Name}}, valLen, err = wire.Unmarshal{{ucFirst .Type}}(b[tagLen:], wtyp)
{{- end}}
{{- end}}
		}
		if err == wire.ErrUnknown {
			if valLen, err = wire.ConsumeFieldValue(num, wtyp, b[tagLen:]); err != nil {
				return err
			}
		} else if err != nil {
			return err
		}
		b = b[tagLen+valLen:]
	}
	return nil
}

{{- end}}

{{- /* ENTITY */ -}}
{{- define "Entity"}}
type {{.Name}} struct {
	id int64
{{- range .Fields}}
{{- if .Repeated}}
	xxx_hidden_{{.Name}} {{.ListType}}
{{- else if .Map}}
	xxx_hidden_{{.Name}} {{.MapType}}
{{- else if eq .TypeKind "component"}}
	xxx_hidden_{{.Name}} *{{.Type}}
{{- else}}
	xxx_hidden_{{.Name}} {{template "FieldType" .}}
{{- end}}
{{- end}}

	dirty uint64
}

func New{{.Name}}(id int64) *{{.Name}} {
	x := new({{.Name}})
	x.id = id
{{- range .Fields}}
{{- if .Repeated}}
	x.init{{.Name}}()
{{- else if .Map}}
	x.init{{.Name}}()
{{- else if eq .TypeKind "component"}}
	x.set{{.Name}}(New{{.Type}}())
{{- end}}
{{- end}}
	x.dirty = 1
	return x
}

func (x *{{.Name}}) Id() int64 {
	return x.id
}
{{- template "Message" .}}

func (x *{{.Name}}) markAll() {
	x.dirty = uint64(0x01)
}

func (x *{{.Name}}) markDirty(n uint64) {
	if x.dirty&n == n {
		return
	}
	x.dirty |= n
}

func (x *{{.Name}}) checkDirty(n uint64) bool {
	return x.dirty&n != 0
}

func (x *{{.Name}}) CheckDirty() bool {
	return x.dirty != 0
}

func (x *{{.Name}}) ClearDirty() {
	if x.dirty == 0 {
		return
	}
{{- range .Fields}}
{{- if .Repeated}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- else if .Map}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- else if eq .TypeKind "component"}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- end}}
{{- end}}
	x.dirty = 0
}
{{- end}}

{{- /* COMPONENT */ -}}
{{- define "Component"}}
type dirtyParentFunc_{{.Name}} func()

func (f dirtyParentFunc_{{.Name}}) invoke() {
	if f == nil {
		return
	}
	f()
}

type {{.Name}} struct {
{{- range .Fields}}
{{- if .Repeated}}
	xxx_hidden_{{.Name}} {{.ListType}}
{{- else if .Map}}
	xxx_hidden_{{.Name}} {{.MapType}}
{{- else if eq .TypeKind "component"}}
	xxx_hidden_{{.Name}} *{{.Type}}
{{- else}}
	xxx_hidden_{{.Name}} {{template "FieldType" .}}
{{- end}}
{{- end}}

	dirty       uint64
	dirtyParent dirtyParentFunc_{{.Name}}
}

func New{{.Name}}() *{{.Name}} {
	x := new({{.Name}})
	x.dirty = 1
{{- range .Fields}}
{{- if .Repeated}}
	x.init{{.Name}}()
{{- else if .Map}}
	x.init{{.Name}}()
{{- else if eq .TypeKind "component"}}
	x.set{{.Name}}(New{{.Type}}())
{{- end}}
{{- end}}
	return x
}
{{- template "Message" .}}

func (x *{{.Name}}) markAll() {
	x.dirty = uint64(0x01)
}

func (x *{{.Name}}) markDirty(n uint64) {
	if x.dirty&n == n {
		return
	}
	x.dirty |= n
	x.dirtyParent.invoke()
}

func (x *{{.Name}}) checkDirty(n uint64) bool {
	return x.dirty&n != 0
}

func (x *{{.Name}}) clearDirty() {
	if x.dirty == 0 {
		return
	}
{{- range .Fields}}
{{- if .Repeated}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- else if .Map}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- else if eq .TypeKind "component"}}
	if x.dirty&uint64(0x01) != 0 || x.dirty&(uint64(0x01)<<{{.Number}}) != 0 {
		x.xxx_hidden_{{.Name}}.clearDirty()
	}
{{- end}}
{{- end}}
	x.dirty = 0
}
{{- end}}
{{- /* END DEFINE */ -}}
{{- /* BEGIN GO */ -}}
// Code generated by kds. DO NOT EDIT.
// source: {{.SourceFile}}

package {{.Package}}
{{- /* IMPORTS */ -}}
{{- if len .GoImportSpecs}}
{{/* EMPTY LINE */}}
import (
{{- range .GoImportSpecs}}
{{- if .SpacesBefore}}
{{/* EMPTY LINE */}}
{{- end}}
	"{{.Path}}"
{{- end}}
)
{{- end}}
{{- /* COMMON TYPES */ -}}
{{- range .Types}}

{{- with findList .}}
{{- if .}}
{{/* EMPTY LINE */}}
{{- template "List" .}}
{{- end}}
{{- end}}
{{- range findMap .}}
{{/* EMPTY LINE */}}
{{- template "Map" .}}
{{- end}}

{{- end}}
{{- /* TOPLEVEL DEFINE */ -}}
{{- range .Defs}}
{{/* EMPTY LINE */}}
{{- if eq .Kind "enum"}}
{{- template "Enum" .}}
{{- with findList .Name}}
{{- if .}}
{{/* EMPTY LINE */}}
{{- template "List" .}}
{{- end}}
{{- end}}
{{- range findMap .Name}}
{{/* EMPTY LINE */}}
{{- template "Map" .}}
{{- end}}

{{- else if eq .Kind "entity"}}
{{- template "Entity" .}}

{{- else if eq .Kind "component"}}
{{- template "Component" .}}
{{- with findList .Name}}
{{- if .}}
{{/* EMPTY LINE */}}
{{- template "List" .}}
{{- end}}
{{- end}}
{{- range findMap .Name}}
{{/* EMPTY LINE */}}
{{- template "Map" .}}
{{- end}}
{{- end}}

{{- end}}
{{/* EMPTY LINE */}}
{{- /* END GO */ -}}
`
